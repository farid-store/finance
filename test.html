<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Receipt Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@v5.0.0/dist/tesseract.min.js"></script>
    <style>
        body { background: #f1f5f9; font-family: 'Inter', sans-serif; }
        .scanner-container { max-width: 500px; margin: 2rem auto; padding: 1rem; }
        .status-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #loadingOverlay { display: none; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        canvas { display: none; }
    </style>
</head>
<body>

    <div id="loadingOverlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center text-white">
        <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="font-bold text-xl mb-2">AI SEDANG BEKERJA</h2>
        <p id="ocrProgress" class="text-indigo-400 font-mono">Menyiapkan Engine...</p>
        <p class="text-[10px] mt-4 text-gray-500 uppercase tracking-widest">Memproses Baris & Logika Angka</p>
    </div>

    <div class="scanner-container">
        <div class="mb-6 text-center">
            <h1 class="text-3xl font-black italic text-slate-900">OCR SCANNER <span class="text-indigo-600">PRO</span></h1>
            <p class="text-xs text-slate-500 font-bold uppercase tracking-tighter">Deteksi Otomatis: Bayar, Total, IDR, Rp</p>
        </div>

        <div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-200 mb-6">
            <div class="flex flex-col items-center justify-center border-2 border-dashed border-slate-300 rounded-2xl p-8 mb-4 hover:border-indigo-500 transition-colors">
                <label class="cursor-pointer flex flex-col items-center">
                    <span class="text-4xl mb-2">ðŸ“¸</span>
                    <span class="font-bold text-slate-700">Ambil Foto Struk</span>
                    <input type="file" accept="image/*" class="hidden" onchange="startSmartScan(this)">
                </label>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Hasil Pembacaan Detail</label>
                    <input type="text" id="resDesc" class="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl font-bold text-slate-700 focus:ring-2 ring-indigo-500 outline-none" placeholder="Menunggu scan...">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Nominal Terdeteksi</label>
                    <div class="relative">
                        <span class="absolute left-4 top-4 font-black text-indigo-600">Rp</span>
                        <input type="number" id="resAmount" class="w-full bg-slate-50 border border-slate-200 p-4 pl-12 rounded-xl font-black text-2xl text-slate-900 focus:ring-2 ring-indigo-500 outline-none" placeholder="0">
                    </div>
                </div>
                <button onclick="saveToLog()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition">SIMPAN KE CATATAN</button>
            </div>
        </div>

        <div id="scanLog" class="space-y-3">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-2">Riwayat Terakhir</p>
        </div>
    </div>

    <canvas id="procCanvas"></canvas>

    <script>
        async function startSmartScan(input) {
            if (!input.files || !input.files[0]) return;
            
            const overlay = document.getElementById('loadingOverlay');
            const progress = document.getElementById('ocrProgress');
            overlay.style.display = 'flex';

            try {
                progress.innerText = "Preprocessing Gambar...";
                const imgBase64 = await preprocessImage(input.files[0]);

                progress.innerText = "Menganalisis Karakter...";
                const worker = await Tesseract.createWorker('ind+eng');
                const result = await worker.recognize(imgBase64);
                const text = result.data.text;
                
                analyzeTextLogic(text);

                await worker.terminate();
            } catch (error) {
                alert("Scan gagal: " + error.message);
            } finally {
                overlay.style.display = 'none';
                input.value = "";
            }
        }

        // FUNGSI LOGIKA UTAMA (Revisi Total)
        function analyzeTextLogic(rawText) {
            const lines = rawText.split('\n');
            let detectedAmount = 0;
            let finalDesc = "";
            let highestAmount = 0;
            let keywordAmount = 0;

            // Keywords sesuai permintaan: bayar, total, idr, rp, jumlah
            const targetKeywords = ["total", "bayar", "idr", "rp", "jumlah", "grand", "amount", "cash"];

            console.log("--- DEBUG OCR BARIS ---");
            
            lines.forEach((line, index) => {
                const cleanLine = line.toLowerCase().replace(/,/g, '.'); // standarisasi koma ke titik
                
                // Cari angka dalam baris (menghapus karakter non-angka kecuali titik/koma)
                // Menangkap format: 15.000, 15000, 15,000.00
                const amountMatch = cleanLine.match(/(\d{1,3}(\.\d{3})+|(\d{4,}))/g);

                if (amountMatch) {
                    amountMatch.forEach(m => {
                        const val = parseInt(m.replace(/\./g, '')); // Bersihkan titik untuk jadi integer
                        
                        // Abaikan angka yang terlalu kecil (bukan harga) atau terlalu panjang (nomor telp/tgl)
                        if (val > 100 && val < 10000000) {
                            
                            // Logika 1: Cek apakah baris ini mengandung KEYWORD
                            const hasKey = targetKeywords.some(k => cleanLine.includes(k));
                            
                            if (hasKey) {
                                // Jika ada keyword "Total/Bayar", kita prioritaskan angka di baris ini
                                keywordAmount = val;
                                console.log(`Baris ${index} (KEYWORD): ${val}`);
                            }

                            // Logika 2: Simpan angka tertinggi (Struk biasanya Total = Angka Terbesar)
                            if (val > highestAmount) {
                                highestAmount = val;
                                console.log(`Baris ${index} (HIGHEST): ${val}`);
                            }
                        }
                    });
                }

                // Ambil deskripsi dari baris 1-3 yang bukan angka
                if (index < 3 && line.length > 5 && !finalDesc) {
                    finalDesc = line.trim();
                }
            });

            // Keputusan Final: prioritaskan angka yang ada keyword-nya, jika tidak ada ambil yang terbesar
            detectedAmount = keywordAmount > 0 ? keywordAmount : highestAmount;

            // Update UI
            document.getElementById('resDesc').value = finalDesc || "Struk Belanja";
            document.getElementById('resAmount').value = detectedAmount;
            
            if (detectedAmount === 0) {
                alert("AI ragu membaca angka. Silakan pastikan foto sangat terang dan tegak lurus.");
            }
        }

        // Preprocessing untuk meningkatkan akurasi: Black & White High Contrast
        function preprocessImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.getElementById('procCanvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Perkecil ukuran jika terlalu besar untuk performa
                        const scale = Math.min(1, 1500 / img.width);
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;

                        // Filter: Grayscale + Contrast
                        ctx.filter = 'grayscale(1) contrast(1.2) brightness(1.1)';
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.9));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function saveToLog() {
            const desc = document.getElementById('resDesc').value;
            const amt = document.getElementById('resAmount').value;
            if (!amt || amt == 0) return;

            const log = document.getElementById('scanLog');
            const item = document.createElement('div');
            item.className = "bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-200";
            item.innerHTML = `
                <div>
                    <p class="text-[10px] text-slate-400 font-bold">${new Date().toLocaleTimeString()}</p>
                    <p class="font-bold text-slate-700">${desc}</p>
                </div>
                <p class="font-black text-indigo-600">Rp ${parseInt(amt).toLocaleString()}</p>
            `;
            log.prepend(item);
        }
    </script>
</body>
</html>
