<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Ledger - Full Detail OCR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@v5.0.0/dist/tesseract.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { background: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; color: #1e293b; }
        .receipt-card { background: #ffffff; border-radius: 24px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); }
        #loadingOverlay { display: none; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); z-index: 100; }
        .hidden-canvas { display: none; }
        .history-item { transition: all 0.2s; border: 1px solid #e2e8f0; }
        .history-item:hover { border-color: #6366f1; transform: translateY(-2px); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loadingOverlay" class="fixed inset-0 flex flex-col items-center justify-center text-white">
        <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-6"></div>
        <h2 class="text-2xl font-extrabold tracking-tight">AI ANALYZING...</h2>
        <p id="ocrStatus" class="text-indigo-400 font-mono text-sm mt-2">Membaca Detail Struk</p>
    </div>

    <div class="max-w-xl mx-auto">
        <header class="mb-8 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-extrabold tracking-tighter text-slate-900">LEDGER <span class="text-indigo-600">SCAN</span></h1>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Detail Extraction Mode</p>
            </div>
            <button onclick="clearAllData()" class="text-red-500 text-[10px] font-bold border border-red-200 px-3 py-1 rounded-full hover:bg-red-50">HAPUS SEMUA</button>
        </header>

        <div class="receipt-card p-6 mb-8">
            <div id="uploadZone" class="relative border-2 border-dashed border-indigo-100 bg-indigo-50/30 rounded-2xl p-8 mb-6 text-center hover:bg-indigo-50 transition-colors cursor-pointer">
                <input type="file" id="fileInput" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="processFullScan(this)">
                <div id="uploadUI">
                    <span class="text-4xl block mb-2">ðŸ“¸</span>
                    <p class="font-bold text-slate-700">Scan Struk Baru</p>
                    <p class="text-[10px] text-slate-500 mt-1">Sistem akan membaca Nama, Tanggal & Total</p>
                </div>
                <img id="imgPreview" class="hidden mx-auto max-h-48 rounded-lg shadow-md mb-2">
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2">
                        <label class="text-[10px] font-extrabold text-slate-400 uppercase mb-1 block">Detail Nama Barang / Toko</label>
                        <input type="text" id="resTitle" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 font-bold focus:outline-indigo-500" placeholder="...">
                    </div>
                    <div>
                        <label class="text-[10px] font-extrabold text-slate-400 uppercase mb-1 block">Tanggal</label>
                        <input type="text" id="resDate" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 text-sm focus:outline-indigo-500" placeholder="dd/mm/yyyy">
                    </div>
                    <div>
                        <label class="text-[10px] font-extrabold text-slate-400 uppercase mb-1 block">Waktu</label>
                        <input type="text" id="resTime" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 text-sm focus:outline-indigo-500" placeholder="00:00">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-extrabold text-slate-400 uppercase mb-1 block">Total Nominal</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3.5 font-bold text-indigo-600">Rp</span>
                        <input type="number" id="resAmount" class="w-full bg-slate-900 text-white p-4 pl-12 rounded-xl text-2xl font-black outline-none shadow-inner" placeholder="0">
                    </div>
                </div>
                <button onclick="saveEntry()" class="w-full bg-indigo-600 text-white font-extrabold py-4 rounded-xl shadow-lg shadow-indigo-200 active:scale-[0.98] transition">SIMPAN KE STORAGE</button>
            </div>
        </div>

        <div id="historyContainer" class="space-y-3 pb-20">
            <h3 class="text-sm font-extrabold text-slate-800 mb-4 flex items-center gap-2">
                ðŸ“‚ RIWAYAT TRANSAKSI
            </h3>
            <div id="logList" class="space-y-3">
                </div>
        </div>
    </div>

    <canvas id="hiddenCanvas" class="hidden-canvas"></canvas>

    <script>
        let db = JSON.parse(localStorage.getItem('receipt_data')) || [];

        window.onload = renderHistory;

        async function processFullScan(input) {
            if (!input.files || !input.files[0]) return;
            
            const overlay = document.getElementById('loadingOverlay');
            const preview = document.getElementById('imgPreview');
            const uploadUI = document.getElementById('uploadUI');
            const status = document.getElementById('ocrStatus');

            // Reset UI
            overlay.style.display = 'flex';
            preview.classList.remove('hidden');
            uploadUI.classList.add('hidden');

            const file = input.files[0];
            preview.src = URL.createObjectURL(file);

            try {
                status.innerText = "Mengoptimalkan Gambar...";
                const processedImg = await prepareImage(file);

                status.innerText = "Mengekstraksi Data AI...";
                const worker = await Tesseract.createWorker('ind+eng');
                const result = await worker.recognize(processedImg);
                const text = result.data.text;

                analyzeFullDetail(text);

                await worker.terminate();
            } catch (err) {
                alert("Scan Error: " + err.message);
            } finally {
                overlay.style.display = 'none';
                // Hide preview setelah selesai agar tidak berantakan
                preview.classList.add('hidden');
                uploadUI.classList.remove('hidden');
                input.value = "";
            }
        }

        function analyzeFullDetail(rawText) {
            const lines = rawText.split('\n');
            let foundAmount = 0;
            let foundDate = "";
            let foundTime = "";
            let foundTitle = "";

            // Keywords Logics
            const moneyKeys = ["total", "bayar", "idr", "rp", "jumlah", "grand", "nett"];
            
            lines.forEach((line, i) => {
                const clean = line.toLowerCase();

                // 1. DETEKSI NAMA (Baris teks pertama yang bermakna)
                if (line.trim().length > 6 && !foundTitle && !clean.match(/[0-9]/)) {
                    foundTitle = line.trim();
                }

                // 2. DETEKSI TANGGAL (Format dd/mm/yy atau dd-mm-yyyy)
                const dateMatch = line.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
                if (dateMatch && !foundDate) foundDate = dateMatch[0];

                // 3. DETEKSI WAKTU (Format 00:00)
                const timeMatch = line.match(/(\d{1,2}[:]\d{2})/);
                if (timeMatch && !foundTime) foundTime = timeMatch[0];

                // 4. DETEKSI NOMINAL (Logika angka terbesar & keywords)
                const amountMatch = clean.match(/(\d{1,3}(\.\d{3})+|(\d{4,}))/g);
                if (amountMatch) {
                    amountMatch.forEach(m => {
                        const val = parseInt(m.replace(/\./g, ''));
                        const hasMoneyKey = moneyKeys.some(k => clean.includes(k));
                        if (val > 500 && val < 10000000) {
                            if (hasMoneyKey) foundAmount = val; 
                            else if (val > foundAmount && !foundAmount) foundAmount = val;
                        }
                    });
                }
            });

            // Fallback jika nama tidak ketemu
            if (!foundTitle) foundTitle = lines[0].substring(0, 20) || "Struk Belanja";

            // Update UI Form
            document.getElementById('resTitle').value = foundTitle;
            document.getElementById('resDate').value = foundDate || new Date().toLocaleDateString('id-ID');
            document.getElementById('resTime').value = foundTime || new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
            document.getElementById('resAmount').value = foundAmount;
        }

        function prepareImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.getElementById('hiddenCanvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        // Filter B&W High Contrast
                        ctx.filter = 'grayscale(1) contrast(1.5) brightness(1.0)';
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas.toDataURL('image/jpeg', 0.9));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // STORAGE LOGICS
        function saveEntry() {
            const title = document.getElementById('resTitle').value;
            const amount = document.getElementById('resAmount').value;
            const date = document.getElementById('resDate').value;
            const time = document.getElementById('resTime').value;

            if (!amount || amount == 0) return alert("Nominal tidak boleh kosong!");

            const newEntry = { id: Date.now(), title, amount, date, time };
            db.unshift(newEntry);
            localStorage.setItem('receipt_data', JSON.stringify(db));
            
            renderHistory();
            resetForm();
        }

        function renderHistory() {
            const list = document.getElementById('logList');
            list.innerHTML = "";

            db.forEach(item => {
                const el = document.createElement('div');
                el.className = "history-item bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm";
                el.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[9px] font-black bg-slate-100 text-slate-500 px-2 py-0.5 rounded uppercase">${item.date}</span>
                            <span class="text-[9px] font-bold text-slate-400">${item.time}</span>
                        </div>
                        <h4 class="font-bold text-slate-800 text-sm">${item.title}</h4>
                    </div>
                    <div class="text-right flex flex-col items-end gap-2">
                        <p class="font-black text-indigo-600">Rp ${parseInt(item.amount).toLocaleString()}</p>
                        <button onclick="deleteEntry(${item.id})" class="text-[10px] text-red-300 hover:text-red-500 transition">HAPUS</button>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function deleteEntry(id) {
            if(confirm('Hapus catatan ini?')) {
                db = db.filter(i => i.id !== id);
                localStorage.setItem('receipt_data', JSON.stringify(db));
                renderHistory();
            }
        }

        function clearAllData() {
            if(confirm('Kosongkan semua riwayat?')) {
                db = [];
                localStorage.removeItem('receipt_data');
                renderHistory();
            }
        }

        function resetForm() {
            document.getElementById('resTitle').value = "";
            document.getElementById('resAmount').value = "";
            document.getElementById('resDate').value = "";
            document.getElementById('resTime').value = "";
        }
    </script>
</body>
</html>
